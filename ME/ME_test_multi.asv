com = 15;

% Load MEGSV Dynamic Link Library
if ~libisloaded('MEGSV86x64')
   loadlibrary('D:\Liang Li\RobotRepeatRealFish\matlab\ME\MEGSV86x64.DLL', 'D:\Liang Li\RobotRepeatRealFish\matlab\ME\MEGSV86x64.h')
end

% Activate channel
extendet = calllib('MEGSV86x64', 'GSV86actExt', com);
if extendet ~= 0
    disp(['Activation error: ', num2str(extendet)]);
    [~, errMsg] = calllib('MEGSV86x64', 'GSV86getLastErrorText', com, '', 256);
    disp(['Activation error message: ', errMsg]);
else
    disp('Channel activated successfully.');
end

% Set the sampling rate to 1000 fps
freqSetResult = calllib('MEGSV86x64', 'GSV86setFrequency', com, 1000);
if freqSetResult ~= 0
    disp(['Frequency set error: ', num2str(freqSetResult)]);
    [~, errMsg] = calllib('MEGSV86x64', 'GSV86getLastErrorText', com, '', 256);
    disp(['Frequency set error message: ', errMsg]);
else
    disp('Frequency set to 1000 fps successfully.');
end

calllib('MEGSV86x64', 'GSV86clearDeviceBuf', com);
calllib('MEGSV86x64', 'GSV86clearDLLbuffer', com);

pause(10);

% Define parameters for GSV86readMultiple
NumMappedObjects = 8; % Total number of channels
ChannelsToRead = 2; % Number of channels we want to read
count = 1000 * ChannelsToRead; % Number of samples to read, ensuring the count is appropriate for 2 channels
valsread = libpointer('int32Ptr', 0); % Pointer to the number of values read
ErrFlags = libpointer('int32Ptr', 0); % Pointer to error flags

% Allocate memory for the output array
out = libpointer('doublePtr', zeros(1, count));

% Read data from the device
[error, ~] = calllib('MEGSV86x64', 'GSV86readMultiple', com, 0, out, count, valsread, ErrFlags);

% Retrieve the actual number of values read
num_vals_read = get(valsread, 'Value');
data = get(out, 'Value');
data = data(1:num_vals_read); % Resize the data array to the number of values actually read

% Check for errors
if error ~= 0
    disp(['GSV86readMultiple error: ', num2str(error)]);
    [~, errMsg] = calllib('MEGSV86x64', 'GSV86getLastErrorText', com, '', 256);
    disp(['GSV86readMultiple error message: ', errMsg]);
end

% Display number of values read and data
disp(['Number of values read: ', num_vals_read)]);

% Separate data for the first 2 channels
channel_data = reshape(data, NumMappedObjects, [])'; % Reshape data into channels
channel_1_data = channel_data(:, 1); % Data for channel 1
channel_2_data = channel_data(:, 2); % Data for channel 2

% Save the data for the first 2 channels
save('channel_1_data.mat', 'channel_1_data');
save('channel_2_data.mat', 'channel_2_data');

disp('Data for Channel 1:');
disp(channel_1_data);
disp('Data for Channel 2:');
disp(channel_2_data);

% Test with GSV86read
adx1 = libpointer('doublePtr', zeros(1, 1));
[error_single, data1] = calllib('MEGSV86x64', 'GSV86read', com, 1, adx1);

% Display single read result
if error_single == 0
    single_value = get(adx1, 'Value');
    disp(['Single read value: ', num2str(single_value)]);
else
    disp(['Single read error: ', num2str(error_single)]);
    [~, errMsg] = calllib('MEGSV86x64', 'GSV86getLastErrorText', com, '', 256);
    disp(['Single read error message: ', errMsg]);
end
